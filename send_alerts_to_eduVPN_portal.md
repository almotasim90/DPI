---
title: EveBox alerts in eduVPN portal. 
description: Ship EveBox alerts eduVPN portal.
category: DPI
---

This page is for sending EveBox alerts from Events SQLite database into EduVPN SQLite databse. EveBox alerts are coming from `eve.json` file, which have all Suricata logs stored in. 

## Requirements

* Suricata up and running. 
* EveBox up and running. 
* Little knowledge about SQLite database.

**NOTE**: If you do not have Suricata installed, Look at this [page](Suricata_Install_and_configure.md). Also, if you want to set up EveBox! Look 
[here](Setup_EveBox.md).


## SQLite3 & EveBox 

EveBox can use an embedded SQLite database suitable for lower load installations, by using the following command:

	$ evebox server -v -D /var/lib/evebox --datastore sqlite --input /var/log/suricata/eve.json

**Note** the `-D` parameter that tells EveBox where to store data files such as the file for the SQLite database. And the `--input` is where the `eve.json` file located to be used as an input. 

By default EveBox run as a server exposing a web interface on port `5636`, to see the result in the browser visit `http://localhost:5636`, Then you should see the events and alerts generated by Suricata. However, we are trying to get the results into eduVPN portal using SQLite database. 

Now we have an SQLite databse in `/var/lib/evebox` usually called `events.sqlite`. You can easily type:

	$ sqlite3 /var/lib/evebox/events.sqlite

It will get you inside the database, type `.help` to see diffrent options and commands to use. For example, you can enter `.tables` to see the xreated tables, Or `.schema` to see the whole schema of the database. 


**Note** if you do not have SQLite3 installed in Debian10, you can easily install it with `apt install sqlite3`.

## SQLite ATTACH Database

Since we are trying to connect between two diffrent databases, When you connect to a database, its name is `main` regardless of the database file name. In addition, you can access the temporary database that holds temporary tables and other database objects via the `temp` database.

Therefore, every SQLite database connection has the `main` database and also `temp` database in case you deal with temporary database objects.

In order to attach an additional database to the current database connection, you can use this following statement inside the current SQLite databse:

	$ ATTACH DATABASE file_name AS database_name;

Which in our case is connecting our main eduVPN databses `/var/lib/vpn-server-api/db.sqlite` to EveBox genertaed databse `/var/lib/evebox/events.sqlite`. the following statement will connect both databses:

	$ ATTACH DATABASE '/var/lib/evebox/events.sqlite'  AS  events

Now,if you run `.databases` you can see something like this: 

	main: /var/lib/vpn-server-api/db.sqlite
	Events: /var/lib/evebox/events.sqlite

That will validate the datbase is attached!


## Query to get data from EveBox databse for User Messages table

The EveBox databse is storing the actuall alert or event as a JSON data, Therefore, an additional option is used in the statments to get those data. we are going to use `json_extract` option. 

**NOTE** You van read more about `json_extract` at this [page](https://samadhiweb.com/blog/2016.04.24.sqlite.json.html).

Since we are going to ship the alerts to eduVPN databse `db.sqlite`, The best place to let each user see his own alerts is under user messages, So that in eduVPN portal the user can see the alerts under `accounts` then `Events`.


The data we are trying to get from the EveBox databse are for the `user_mesages` table in EduVpn database `db.sqlite`. So, To insert data into `user_message` table, we needs all of : 

	id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
	type VARCHAR(255) NOT NULL DEFAULT "notification",
	message TINYTEXT NOT NULL,
	date_time DATETIME NOT NULL

The query that used to get the needed data from EveBox databse is: 

	$ select json_extract(source, '$.event_type'), json_extract(source, '$.alert.signature'), json_extract(source, '$.timestamp'), user_id from main.connection_log join events.events where (main.connection_log.ip4 = json_extract(source, '$.dest_ip') OR main.connection_log.ip4 = json_extract(source, '$.src_ip'));

`event_type` will be stored as `type`, `alert.signature` which is the suricata alert message,will be stored as `message`, and finally the `timestamp` will be stored as the `date_time` 


**NOTE** It is important that each user gets his own alerts, with out any conflict with other users. That is why we need `user_id` from `connection_log` table, so that later we could insert the right data in the right place.


However, an IP address can be used by diffrent users. So an additional filter is added to make sure that each user get his own alerts at the certain time he was connected to that IP address. Also, we need to make sure that user sees only alerts not any flow logs, so another filter added. The result is this query:

	$ select json_extract(source, '$.event_type'), json_extract(source, '$.alert.signature'), json_extract(source, '$.timestamp'), user_id from main.connection_log join events.events where (main.connection_log.ip4 = json_extract(source, '$.dest_ip') OR main.connection_log.ip4 = json_extract(source, '$.src_ip')) AND json_extract(source, '$.alert') LIKE '% %' AND  json_extract(events.source, '$.timestamp') BETWEEN connected_at and disconnected_at;

By matching the `timesatmp` with `connected_at` and `disconnected_at` time, we will make sure that alerts generated that time belongs to that user. So with this query yo can get all the needed data to be inserted into `user_messages` table.



## Insert Alerts into USER_MESSAGES table

To insert data into a table, you use the `INSERT` statement. SQLite provides various forms of the `INSERT` statements that allow you to insert a single row, multiple rows, and default values into a table. In addition, you can insert a row into a table using data provided by a  `SELECT` statement.

**NOTE** More infromation about SQLite inert can be found [here](https://www.sqlitetutorial.net/sqlite-insert/).

So, now you do have already a query to be inserted into `user_messages` table. You could easily insert a row into a table using data provided by a  `SELECT` statement. like the following statement: 

	$  INSERT INTO user_messages (type, message, date_time,user_id) select json_extract(source, '$.event_type'), json_extract(source, '$.alert.signature'), json_extract(source, '$.timestamp'), user_id from main.connection_log join events.events where main.connection_log.ip4 = json_extract(source, '$.dest_ip') AND json_extract(source, '$.alert') LIKE '% %' AND  json_extract(events.source, '$.timestamp') BETWEEN connected_at and disconnected_at;


This will insert the alerts for each user without any conflict!

**HOWEVER** This kind of inseration will be automated. That means it will be inserted more than once upon the time. So, you have to make sure that inserted data are not getting duplicated. With taking this into considration, another filter added to make sure that the alerts inserted is not dublicated. You are going to use `NOT_IN`  operator or similar. The end statement result will be this query:

	$ INSERT INTO user_messages (type, message, date_time,user_id) select json_extract(source, '$.event_type'), json_extract(source, '$.alert.signature'), json_extract(source, '$.timestamp'), user_id from main.connection_log join events.events where main.connection_log.ip4 = json_extract(source, '$.dest_ip') AND json_extract(source, '$.alert') LIKE '% %' AND  json_extract(events.source, '$.timestamp') BETWEEN connected_at and disconnected_at AND user_id NOT IN (select user_id from user_messages where message = json_extract(source, '$.alert.signature') AND date_time =json_extract(source, '$.timestamp')); 

That is the final query to insert the alerts into  `user_messages` table safely. 

Now, as a user you can go to eduVPN portal, Then, after login go to `accounts` then under `Events` you should see the alerts. 



## Automate inseration with CRONTAB tool

CRONTAB tool is used for files used to schedule the execution of programs. You are going to schedule an insert command, to insert all the alerts into 
`user_messages` table. By typing this command in the terminal:

	$ crontab -e 


**NOTE** more infromamtion about Crontab can be found [here](https://man7.org/linux/man-pages/man5/crontab.5.html).


It will open a page where you can list all the scheduled programs.In this example, the ping will be every 5 mins, it will look like this: 

	$ */5 * * * * ping google.com

Or it could be in an executable file, lets name it `test.sh`:

	$ */5 * * * * /path/to/test.sh

The same for the inseration commands. the shell file `test.sh` should be like this:

	#!/bin/bash

	sqlite3 /var/lib/vpn-server-api/db.sqlite " ATTACH DATABASE '/var/lib/evebox/events.sqlite' AS events; 
	INSERT INTO user_messages (type, message, date_time,user_id) select json_extract(source, '$.event_type'), json_extract(source, '$.alert.signature'), json_extract(source, '$.timestamp'), user_id from main.connection_log join events.events where main.connection_log.ip4 = json_extract(source, '$.dest_ip') AND json_extract(source, '$.alert') LIKE '% %' AND  json_extract(events.source, '$.timestamp') BETWEEN connected_at and disconnected_at AND user_id NOT IN (select user_id from user_messages where message = json_extract(source, '$.alert.signature') AND date_time =json_extract(source, '$.timestamp'));"

Now the inseration will be done every 5 mins. 












	

